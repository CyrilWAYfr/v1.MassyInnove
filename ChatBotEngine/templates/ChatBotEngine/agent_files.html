{% extends "base.html" %}
{% load static %}

{% block title %}Fichiers de lâ€™agent â€” {{ agent.title }}{% endblock %}

{% block content %}

  
  <!-- Titre + bouton retour paramÃ¨tres -->
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h1 class="mb-0">
      Fichiers de lâ€™agent <small class="text-muted">Â« {{ agent.title }} Â»</small>
    </h1>
    <a href="{% url 'chatbotengine:update_chatbot' agent.id %}"
       class="btn btn-sm btn-outline-secondary">
      â† ParamÃ¨tres de lâ€™agent
    </a>
  </div>

  {# Ã‰tat de la librairie Mistral de lâ€™agent #}
  <div class="alert alert-info d-flex align-items-center gap-2" role="alert">
    <span class="me-2">ğŸ“š</span>
    <div>
      {% if agent.mistral_library_id %}
        Identification interne de la Librairie Mistral : <code>{{ agent.mistral_library_id }}</code><br>
      {% else %}
        Aucune librairie Mistral nâ€™est encore crÃ©Ã©e pour cet agent.<br>
        Elle sera <strong>crÃ©Ã©e automatiquement</strong> lors du premier ajout de fichier.
      {% endif %}
    </div>
  </div>

  {# FICHIERS DÃ‰JÃ€ LIÃ‰S Ã€ Lâ€™AGENT #}
  <div class="card mb-4">
    <div class="card-header">
      <strong>Fichiers dÃ©jÃ  liÃ©s Ã  lâ€™agent</strong>
      <span class="badge bg-secondary ms-2">{{ links|length }}</span>
    </div>
    <div class="card-body p-0">
      {% if links %}
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th>Nom</th>
                <th>Statut</th>
                <th class="text-nowrap">ID doc Mistral</th>
                <th class="text-nowrap">AjoutÃ© par</th>
                <th class="text-end">Action</th>
              </tr>
            </thead>
            <tbody>
              {% for link in links %}
              {% with f=link.file %}
              <tr>
                <td class="text-break">
                  {% firstof f.original_name f.name %}
                </td>
                <td>
                  {% if f.processing_status == "Completed" or f.processing_status == "Succeeded" %}
                    <span class="badge bg-success">IndexÃ©</span>
                  {% else %}
                    <span class="badge bg-warning text-dark">{{ f.processing_status|default:"â€”" }}</span>
                  {% endif %}
                </td>
                <td class="font-monospace small text-break">
                  {{ f.mistral_document_id|default:"â€”" }}
                </td>
                <td class="text-nowrap">
                  {{ link.added_by|default:"â€”" }}
                </td>
                <td class="text-end">
                  <form method="post" action="{% url 'chatbotengine:agent_files_remove' link.id %}" class="d-inline">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-sm btn-outline-danger">
                      Retirer
                    </button>
                  </form>
                </td>
              </tr>
              {% endwith %}
              {% endfor %}
            </tbody>
          </table>
        </div>
      {% else %}
        <div class="p-3">
          <em>Aucun fichier nâ€™est encore liÃ© Ã  cet agent.</em>
        </div>
      {% endif %}
    </div>
  </div>

  {# UPLOAD UNITAIRE POUR LA LIBRAIRIE DE L'AGENT #}
<div class="card">
  <div class="card-header">
    <strong>Ajouter un fichier Ã  la librairie de lâ€™agent</strong>
  </div>
  <div class="card-body">
    <p class="text-muted small mb-3">
      Le fichier sera <strong>envoyÃ© directement</strong> dans la librairie Mistral de lâ€™agent
      (crÃ©Ã©e automatiquement si besoin).
    </p>

    <form method="post" action="{% url 'chatbotengine:agent_files_upload' agent.id %}" enctype="multipart/form-data" class="d-flex gap-2 flex-wrap align-items-center">
      {% csrf_token %}
      <input type="file" name="file" class="form-control" style="max-width:420px" required>
      <button type="submit" class="btn btn-primary">Uploader</button>
    </form>

    <div class="form-text mt-2">
      Formats usuels acceptÃ©s (PDF, DOCX, PPTX, XLSX, TXTâ€¦). Lâ€™indexation peut prendre quelques minutes.
    </div>
  </div>
</div>

  
</div>
{% endblock %}
