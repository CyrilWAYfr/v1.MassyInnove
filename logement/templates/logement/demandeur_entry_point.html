{% extends "base.html" %}
{% load static %}

{% block content %}

<h2 class="mb-4">{{ domaine.libelle }} - Identification du demandeur concerné</h2>

<div class="row">
  <div class="col-lg-8">

    <div class="card mb-3">
      <div class="card-body">
        <form method="get" class="row g-2 align-items-center">
          <div class="col-auto">
            <input type="text" name="q" value="{{ q }}" class="form-control form-control-sm"
                   placeholder="Rechercher email / numéro">
          </div>

          <div class="col-auto">
            <select name="sort" class="form-select form-select-sm">
              <option value="email"  {% if sort == "email" %}selected{% endif %}>Email (A→Z)</option>
              <option value="-email" {% if sort == "-email" %}selected{% endif %}>Email (Z→A)</option>
              <option value="-last"  {% if sort == "-last" %}selected{% endif %}>Dernier contact (récent)</option>
              <option value="last"   {% if sort == "last" %}selected{% endif %}>Dernier contact (ancien)</option>
            </select>
          </div>

          <div class="col-auto">
            <button class="btn btn-sm btn-outline-primary" type="submit">Filtrer</button>
          </div>
        </form>
      </div>
    </div>

    <div class="card">
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0">
            <thead>
              <tr>
                <th>Email</th>
                <th>Numéro</th>
                <th>Dernier contact</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
              {% for d in page.object_list %}
                <tr>
                  <td>{{ d.email }}</td>
                  <td>{{ d.num_unique|default:"—" }}</td>
                  <td>{% if d.last_contact %}{{ d.last_contact|date:"d/m/Y" }}{% else %}—{% endif %}</td>
                  <td class="text-end">
                    <form method="post" class="d-inline">
                      {% csrf_token %}
                      <input type="hidden" name="action" value="use_existing">
                      <input type="hidden" name="demandeur_id" value="{{ d.id }}">
                      <button class="btn btn-sm btn-success">Utiliser</button>
                    </form>
                  </td>
                </tr>
              {% empty %}
                <tr><td colspan="5" class="text-center text-muted p-3">Aucun demandeur.</td></tr>
              {% endfor %}
            </tbody>
          </table>
          
          <p class="mt-2 mb-2 text-muted fst-italic" style="font-size: 0.85rem;">
                Tous les demandeurs connus dans les différentes domaines de Massy Innove sont affichés ici,
                même s’ils ne sont pas encore connus des domaines sur lesquels vous êtes habilités « {{ domaine.libelle }} ».
            </p>

          
        </div>
      </div>

      {% if page.paginator.num_pages > 1 %}
      <div class="card-footer d-flex justify-content-between align-items-center">
        <div class="text-muted small">
          Page {{ page.number }} / {{ page.paginator.num_pages }}
        </div>
        <div>
          {% if page.has_previous %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?q={{ q|urlencode }}&sort={{ sort|urlencode }}&page={{ page.previous_page_number }}">Précédent</a>
          {% endif %}
          {% if page.has_next %}
            <a class="btn btn-sm btn-outline-secondary"
               href="?q={{ q|urlencode }}&sort={{ sort|urlencode }}&page={{ page.next_page_number }}">Suivant</a>
          {% endif %}
        </div>
      </div>
      {% endif %}
    </div>

  </div>

  <div class="col-lg-4">

    <div class="card">
      <div class="card-body">
        <h5 class="mb-3">Créer un nouveau demandeur</h5>

        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="create_demandeur">

          <div class="mb-2">
            <label class="form-label">Email</label>
            <input type="email" name="email" class="form-control form-control-sm"
                   value="{{ create_form.email.value|default:'' }}">
            {% if create_form.email.errors %}
              <div class="text-danger small">{{ create_form.email.errors|striptags }}</div>
            {% endif %}
          </div>

          <div class="mb-3">
            <label class="form-label">Numéro unique (optionnel)</label>
            <input type="text" name="num_unique" class="form-control form-control-sm"
                   value="{{ create_form.num_unique.value|default:'' }}">
            {% if create_form.num_unique.errors %}
              <div class="text-danger small">{{ create_form.num_unique.errors|striptags }}</div>
            {% endif %}
          </div>

          <button class="btn btn-sm btn-primary w-100">Créer et utiliser</button>
        </form>

      </div>
    </div>

  </div>
</div>

<div class="mt-3">
    <button type="button"
            class="btn btn-secondary btn-sm"
            onclick="history.back()">
        Retour
    </button>
</div>


{% endblock %}
