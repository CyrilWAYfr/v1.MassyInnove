{% extends "base.html" %}

{% block content %}
<h1>Liste des demandeurs</h1>

<form method="get" class="row g-2 align-items-end mb-3" autocomplete="off">
    {% if return_url %}
    <input type="hidden" name="return_url" value="{{ return_url }}">
    {% endif %}
    <div class="col-md-4">
        <label for="num_unique" class="form-label">Numéro unique</label>
        <input
            type="text"
            id="num_unique"
            name="num_unique"
            class="form-control"
            value="{{ search_num_unique }}"
            placeholder="Ex: 12345"
            autocomplete="off"
        >
    </div>
    <div class="col-md-4">
        <label for="email" class="form-label">Email</label>
        <input
            type="text"
            id="email"
            name="email"
            class="form-control"
            value="{{ search_email }}"
            placeholder="Ex: nom@domaine.fr"
            autocomplete="off"
        >
    </div>
    <div class="col-md-4 d-flex gap-2">
        <button type="submit" class="btn btn-primary">Filtrer</button>
        <a
            href="{% if return_url %}?return_url={{ return_url|urlencode }}{% else %}{% url 'logement:demandeurs_list' %}{% endif %}"
            class="btn btn-outline-secondary"
        >
            Réinitialiser
        </a>
    </div>
</form>

<table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Numéro unique</th>
            <th>Email</th>
            <th>Téléphone</th>
            <th>Dernier contact entrant</th>
            <th>Nb contacts</th>
            <th>Actions</th>
        </tr>
    </thead>

    <tbody>
        {% for d in demandeurs %}
        <tr>
            <td>{{ d.num_unique|default:"—" }}</td>
            <td>{{ d.email|default:"—" }}</td>
            <td>{{ d.telephone|default:"—" }}</td>

            <td>
                {% if d.dernier_contact %}
                    {{ d.dernier_contact|date:"d/m/Y H:i" }}
                {% else %}
                    <span class="text-muted">—</span>
                {% endif %}
            </td>

            <td>{{ d.nb_contacts }}</td>
            
            <td class="d-flex gap-1">

    <a href="{% url 'logement:demandeur_detail' d.id %}?return_url={{ request.get_full_path|urlencode }}"
       class="btn btn-primary btn-sm">
        Détails
    </a>

    <a href="{% url 'logement:demandeur_edit' d.id %}?return_url={{ request.get_full_path|urlencode }}"
       class="btn btn-sm btn-outline-primary">
        Modifier
    </a>


    <form method="post"
          action="{% url 'logement:demandeur_delete' demandeur_id=d.id %}"
          onsubmit="return confirm('Confirmer la suppression de ce demandeur ?');"
          class="d-inline">

        {% csrf_token %}
        <input type="hidden" name="return_url"
               value="{{ request.get_full_path }}">
        <button type="submit" class="btn btn-sm btn-outline-danger">
            Supprimer
        </button>
    </form>

</td>

            
        </tr>
        {% empty %}
        <tr>
            <td colspan="6" class="text-center text-muted p-3">Aucun demandeur trouvé.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% if page_obj.paginator.num_pages > 1 %}
<nav aria-label="Pagination demandeurs" class="mt-3">
    <ul class="pagination">
        {% if page_obj.has_previous %}
        <li class="page-item">
            <a
                class="page-link"
                href="?page={{ page_obj.previous_page_number }}&num_unique={{ search_num_unique|urlencode }}&email={{ search_email|urlencode }}{% if return_url %}&return_url={{ return_url|urlencode }}{% endif %}"
            >
                Précédent
            </a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Précédent</span></li>
        {% endif %}

        {% for num in page_obj.paginator.page_range %}
        <li class="page-item {% if page_obj.number == num %}active{% endif %}">
            <a
                class="page-link"
                href="?page={{ num }}&num_unique={{ search_num_unique|urlencode }}&email={{ search_email|urlencode }}{% if return_url %}&return_url={{ return_url|urlencode }}{% endif %}"
            >
                {{ num }}
            </a>
        </li>
        {% endfor %}

        {% if page_obj.has_next %}
        <li class="page-item">
            <a
                class="page-link"
                href="?page={{ page_obj.next_page_number }}&num_unique={{ search_num_unique|urlencode }}&email={{ search_email|urlencode }}{% if return_url %}&return_url={{ return_url|urlencode }}{% endif %}"
            >
                Suivant
            </a>
        </li>
        {% else %}
        <li class="page-item disabled"><span class="page-link">Suivant</span></li>
        {% endif %}
    </ul>
</nav>
{% endif %}

<div class="mt-4">
    {% if return_url %}
    <a href="{{ return_url }}" class="btn btn-secondary">
        ← Retour à l’accueil
    </a>
{% else %}
    <a href="{% url 'home' %}" class="btn btn-secondary">
        ← Retour à l’accueil
    </a>
{% endif %}

</div>


{% endblock %}
