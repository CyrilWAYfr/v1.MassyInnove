{# templates/logement/_dashboard_stats.html #}

<div class="col-12">
    <hr class="my-4">
    <h4 class="text-muted mb-3">
        Principaux chiffres d'activité du service :
    </h4>
</div>

<div class="row align-items-stretch">

    {# === 1. Répartition par statut (dernier mois dispo) === #}
<div class="col-lg-3 col-md-6 mb-3">
  <div class="card h-100 shadow-sm">
    <div class="card-body">
      <h6 class="card-title mb-3">
        Mois en cours ({{ stats_month_label|default:"?" }})
      </h6>

      <div class="table-responsive">
        <table class="table table-sm mb-0">
          <thead>
            <tr>
              <th>Statut</th>
              <th class="text-end">Total</th>
            </tr>
          </thead>
          <tbody>
            {% for row in stats_statut_mois %}
              <tr>
                <td>{{ row.statut_libelle|default:"Non défini" }}</td>
                <td class="text-end fw-semibold">{{ row.total }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="2" class="text-muted">
                  Aucun statut à afficher (stats_statut_mois est vide)
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      
    </div>
  </div>
</div>


    {# === 2. Graphe mensuel par statut (compact) === #}
    <div class="col-lg-5 col-md-6 mb-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body">

                <h6 class="card-title mb-3">
                    Évolution mensuelle
                </h6>

                <canvas id="statutStackedChart" height="90"></canvas>

            </div>
        </div>
    </div>

    {# === 3. Top thématiques (inchangé) === #}
    <div class="col-lg-4 col-md-12 mb-3">
        <div class="card h-100 shadow-sm">
            <div class="card-body">

                <h6 class="card-title mb-3">
                    Top Thématiques (depuis le début)
                </h6>

                <ul class="list-group list-group-flush">
                    {% for t in top_thematiques_mtd %}
                        <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                            <span>{{ t.thematiques__libelle_thematique }}</span>
                            <span class="badge text-bg-secondary rounded-pill">
                                {{ t.total }}
                            </span>
                        </li>
                    {% empty %}
                        <li class="list-group-item text-muted px-0">
                            Aucune thématique sur la période.
                        </li>
                    {% endfor %}
                </ul>

            </div>
        </div>
    </div>

</div>

<script>
(function () {

    const rawData = [
      {% for row in statut_mois_ytd %}
      {
        month: "{{ row.year }}-{{ row.month|stringformat:'02d' }}",
        statut: "{{ row.statut_libelle|default:'Non défini'|escapejs }}",
        total: {{ row.total }}
      },
      {% endfor %}
    ];

    if (!rawData.length) {
        console.warn("Aucune donnée pour le graphe");
        return;
    }

    const months = [...new Set(rawData.map(r => r.month))].sort();

    const STATUT_ORDER = ["Nouveau", "Brouillon", "Répondu"];

    const STATUT_COLORS = {
        "Nouveau": "#dc3545",
        "Brouillon": "#ffc107",
        "Répondu": "#198754"
    };

    // Statuts présents, MAIS dans l'ordre métier imposé
    const statuts = STATUT_ORDER.filter(
        statut => rawData.some(r => r.statut === statut)
    );

    const datasets = statuts.map((statut, idx) => ({
        label: statut,
        data: months.map(month =>
            rawData
                .filter(r => r.month === month && r.statut === statut)
                .reduce((sum, r) => sum + r.total, 0)
        ),
        backgroundColor: STATUT_COLORS[statut],
        borderColor: STATUT_COLORS[statut],
        stack: "statuts",
        order: idx   // ordre d'empilement garanti
    }));

    const canvas = document.getElementById("statutStackedChart");
    if (!canvas) {
        console.error("Canvas statutStackedChart introuvable");
        return;
    }

    const ctx = canvas.getContext("2d");

    new Chart(ctx, {
        type: "bar",
        data: {
            labels: months,
            datasets: datasets
        },
        options: {
            responsive: true,
            plugins: {
                legend: {
                    position: "bottom",
                    labels: {
                        sort: (a, b) => {
                            const ia = STATUT_ORDER.indexOf(a.text);
                            const ib = STATUT_ORDER.indexOf(b.text);
                            return ia - ib;
                        }
                    }
                }
            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: { precision: 0 }
                }
            }
        }
    });

})();
</script>
