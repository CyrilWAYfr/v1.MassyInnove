{% extends "base.html" %}
{% load static i18n %}

{% block title %}Massy Innove : Aide aux CR - 2/2{% endblock %}

{% block page_title %}
  <h1 class="main-title">Résultat de l'analyse par l'IA V2</h1>
{% endblock %}

{% block page_description %}
  <p class="description-text">
    Voici ce que l'IA a compris de votre réunion V2. Rappelez-vous que toute IA peut se tromper et halluciner,
    vous seul êtes responsable in fine du contenu du compte-rendu que vous diffuserez. Vérifiez et corrigez
    donc si nécessaire chacun des éléments qui vous sont présentés ci-dessous AVANT de générer le compte-rendu. Si vous avez choisi de ne pas utiliser l'IA, des données fictives sont présentes dans le formulaire pour le rendre plus facile à comprendre.
  </p>

  {# Barre d’actions de page #}
  <div class="button-container">
    <a href="{% url 'assistantcr:home' %}"
       class="action-button upload-button"
       title="Revenir à l'étape précédente">
      <i class="fas fa-upload" aria-hidden="true"></i>
      <span class="sr-only">Revenir</span>
      Revenir à l'étape précédente
    </a>

    <form id="generate-form" method="post" action="{% url 'assistantcr:generate_meeting_minutes_from_form' %}">
      {% csrf_token %}
      <input id="json-data-input" type="hidden" name="json_data" value='{{ json_data|default:"" }}'>
      <button type="submit" class="btn btn-success">Générer le Word</button>
    </form>
    
    <form id="generate-form-pdf" method="post" action="{% url 'assistantcr:generate_meeting_minutes_pdf' %}">
  {% csrf_token %}
  <input id="json-data-input-pdf" type="hidden" name="json_data" value='{{ json_data|default:"" }}'>
  <button type="submit" class="btn btn-success">Générer le PDF</button>
</form>


  </div>
{% endblock %}


{% block content %}
  <div class="content-card">
    <form id="meetingForm">
      {% csrf_token %}

      <div class="form-group">
        <label for="objet">Objet de la réunion :</label>
        <input type="text" class="form-control" id="objet" name="objet"
               value="{{ data.reunion.objet }}" placeholder="Entrez l'objet de la réunion" required>
      </div>

      <div class="form-inline">
        <div class="form-group mr-3" style="flex: 1;">
          <label for="date">Date :</label>
          <input type="date" class="form-control" id="date" name="date" value="{{ data.reunion.date }}" required>
        </div>
        <div class="form-group" style="flex: 1;">
          <label for="lieu">Lieu :</label>
          <input type="text" class="form-control" id="lieu" name="lieu"
                 value="{{ data.reunion.lieu }}" placeholder="Entrez le lieu de la réunion" required>
        </div>
      </div>

      <br>

      {# Ordre du jour #}
      <div class="section">
        <h3>Ordre du Jour</h3>
        <table class="table" id="ordre-du-jour-table">
          <thead>
            <tr><th style="width:80%;">Point</th><th style="width:20%;">Actions</th></tr>
          </thead>
          <tbody>
            {% for item in data.reunion.ordre_du_jour %}
            <tr>
              <td>
                <input type="text" class="form-control" name="point[]" value="{{ item }}"
                       placeholder="Entrez un point à l'ordre du jour" required>
              </td>
              <td class="action-buttons">
                <button type="button" class="btn btn-reorder btn-sm move-up" title="Monter ce point">
                  <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-reorder btn-sm move-down" title="Descendre ce point">
                  <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-danger btn-sm remove-row" title="Supprimer ce point">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <button type="button" class="btn btn-secondary" id="add-ordre-du-jour" title="Ajouter un point à l'ordre du jour">
          <i class="fas fa-plus"></i> Ajouter un point à l'ordre du jour
        </button>
      </div>

      {# Participants #}
      <div class="section">
        <h3>Participants</h3>
        <table class="table" id="participants-table">
          <thead>
            <tr><th>Nom</th><th>Rôle</th><th>Actions</th></tr>
          </thead>
          <tbody>
            {% for participant in data.reunion.participants %}
            <tr>
              <td><input type="text" class="form-control" name="nom[]" value="{{ participant.nom }}" placeholder="Nom du participant" required></td>
              <td><input type="text" class="form-control" name="role[]" value="{{ participant.role }}" placeholder="Rôle du participant" required></td>
              <td><button type="button" class="btn btn-danger btn-sm remove-row" title="Supprimer ce participant"><i class="fas fa-trash"></i></button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <button type="button" class="btn btn-secondary" id="add-participant" title="Ajouter un participant">
          <i class="fas fa-plus"></i> Ajouter un participant
        </button>
      </div>

      {# Teneur de la réunion #}
      <div class="section">
        <h3>Teneur de la Réunion</h3>
        <table class="table" id="teneur-de-la-reunion-table">
          <thead>
            <tr>
              <th style="width:30%;">Point de l'ordre du jour</th>
              <th style="width:50%;">Discussion</th>
              <th style="width:20%;">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for point in data.reunion.teneur_de_la_reunion %}
            <tr>
              <td><input type="text" class="form-control" name="point_ordre_du_jour[]" value="{{ point.point_ordre_du_jour }}" placeholder="Point de l'ordre du jour" required></td>
              <td><textarea class="form-control" name="discussion[]" placeholder="Discussion sur ce point">{{ point.discussion }}</textarea></td>
              <td class="action-buttons">
                <button type="button" class="btn btn-reorder btn-sm move-up" title="Monter ce point">
                  <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-reorder btn-sm move-down" title="Descendre ce point">
                  <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-danger btn-sm remove-row" title="Supprimer ce point">
                  <i class="fas fa-trash"></i>
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <button type="button" class="btn btn-secondary" id="add-teneur" title="Ajouter un point discuté">
          <i class="fas fa-plus"></i> Ajouter un point discuté
        </button>
      </div>

      {# Récapitulatif #}
      <div class="section">
        <h3>Récapitulatif Qui Fait Quoi</h3>
        <table class="table" id="recapitulatif-table">
          <thead>
            <tr><th>Tâche</th><th>Responsable</th><th>Échéance</th><th>Actions</th></tr>
          </thead>
          <tbody>
            {% for task in data.reunion.recapitulatif_qui_fait_quoi %}
            <tr>
              <td><input type="text" class="form-control" name="tache[]" value="{{ task.tache }}" placeholder="Tâche à accomplir" required></td>
              <td><input type="text" class="form-control" name="responsable[]" value="{{ task.responsable }}" placeholder="Responsable de la tâche" required></td>
              <td><input type="date" class="form-control" name="echeance[]" value="{{ task.echeance }}" required></td>
              <td><button type="button" class="btn btn-danger btn-sm remove-row" title="Supprimer cette tâche"><i class="fas fa-trash"></i></button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        <button type="button" class="btn btn-secondary" id="add-recap" title="Ajouter une action">
          <i class="fas fa-plus"></i> Ajouter une action
        </button>
      </div>
    </form>
  </div>
{% endblock %}

{% block head_css %}
<style>
  /* Arrière-plan doux de la page */
  body {
    background-color: #e5ddd5;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='4' height='4' viewBox='0 0 4 4'%3E%3Cpath fill='%23d6cbb4' fill-opacity='0.2' d='M1 3h1v1H1V3zm2-2h1v1H3V1z'%3E%3C/path%3E%3C/svg%3E");
  }

  /* Carte de contenu principale (évite d'écraser .form-container globale) */
  .content-card {
    padding: 30px;
    width: 80%;
    max-width: 1200px;
    background-color: rgba(255,255,255,0.9);
    border-radius: 10px;
    margin: 0 auto 20px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    overflow: auto;
  }

  .button-container {
    display: flex;
    gap: 20px;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
  }
  .action-button {
    background-color: #075E54;
    color: #fff;
    padding: 10px 20px;
    border: 0;
    border-radius: 5px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 500;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    transition: all .3s ease;
    width: 260px;
    height: 50px;
    text-align: center;
  }
  .action-button:hover { background-color: #128C7E; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,.1); }
  .upload-button { background-color: #f0f0f0; color: #333; border: 1px solid #ccc; }
  .upload-button:hover { background-color: #e0e0e0; color: #333; }

  .main-title { font-size: 22px; color: #075E54; margin-bottom: 15px; }
  .description-text {
    font-size: 13px; font-style: italic; color: #555; margin: 0 auto 25px;
    max-width: 700px; line-height: 1.6; text-align: center; padding: 0 15px; opacity: .9;
  }

  .section { margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 1px solid #dee2e6; }
  .form-inline .form-group { margin-right: 1rem; }
  .form-inline .form-group label { margin-right: .5rem; font-size: .9rem; }
  #objet { width: 100%; max-width: 100%; }

  #teneur-de-la-reunion-table td:nth-child(1){ width:30%; }
  #teneur-de-la-reunion-table td:nth-child(2){ width:50%; }
  #recapitulatif-table td:nth-child(1){ width:70%; }
  #recapitulatif-table td:nth-child(2){ width:30%; }
  #recapitulatif-table td:nth-child(3){ width:1%; white-space:nowrap; }

  .btn-success { background-color:#075E54; border-color:#075E54; }
  .btn-success:hover { background-color:#128C7E; border-color:#128C7E; }
  .btn-secondary { background-color:#f0f0f0; border-color:#ccc; color:#333; }
  .btn-danger { background-color:#dc3545; border-color:#dc3545; }

  .btn-reorder { background-color:#6c757d; border-color:#6c757d; color:#fff; margin:0 2px; }
  .btn-reorder:hover { background-color:#5a6268; border-color:#545b62; }
  .btn-reorder:disabled { opacity:.5; cursor:not-allowed; }

  .form-control { font-size:.9rem; line-height:1.4; }
  textarea.form-control { min-height:100px; resize:vertical; font-size:.9rem; }
  label, th, h3 { font-size:.9rem; }
  h3 { font-size:1.2rem; }
  .action-buttons { white-space:nowrap; display:flex; align-items:center; justify-content:center; }
  .btn-sm { font-size:.8rem; padding:.25rem .5rem; }
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
  function attachAllEventListeners() {
    attachRemoveEventListeners();
    setupReorderButtons('ordre-du-jour-table');
    setupReorderButtons('teneur-de-la-reunion-table');
  }
  function attachRemoveEventListeners() {
    document.querySelectorAll('.remove-row').forEach(button => {
      button.addEventListener('click', function(e) {
        if (confirm("Êtes-vous sûr de vouloir supprimer cette ligne ?")) {
          const row = e.target.closest('tr');
          row.remove();
          updateReorderButtons('ordre-du-jour-table');
          updateReorderButtons('teneur-de-la-reunion-table');
          updateJsonData();
        }
      });
    });
  }
  function setupReorderButtons(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    updateReorderButtons(tableId);
    tbody.querySelectorAll('.move-up').forEach(button => {
      button.addEventListener('click', function(e) {
        const row = e.target.closest('tr');
        moveRowUp(row, tbody);
        updateReorderButtons(tableId);
        updateJsonData();
      });
    });
    tbody.querySelectorAll('.move-down').forEach(button => {
      button.addEventListener('click', function(e) {
        const row = e.target.closest('tr');
        moveRowDown(row, tbody);
        updateReorderButtons(tableId);
        updateJsonData();
      });
    });
  }
  function updateReorderButtons(tableId) {
    const table = document.getElementById(tableId);
    if (!table) return;
    const tbody = table.querySelector('tbody');
    if (!tbody) return;
    const rows = Array.from(tbody.querySelectorAll('tr'));
    rows.forEach((row, index) => {
      const upButton = row.querySelector('.move-up');
      const downButton = row.querySelector('.move-down');
      if (upButton) upButton.disabled = index === 0;
      if (downButton) downButton.disabled = index === rows.length - 1;
    });
  }
  function moveRowUp(row, tbody) {
    const prevRow = row.previousElementSibling;
    if (prevRow) tbody.insertBefore(row, prevRow);
  }
  function moveRowDown(row, tbody) {
    const nextRow = row.nextElementSibling;
    if (nextRow) tbody.insertBefore(nextRow, row);
  }

  // Ajouts dynamiques
  document.getElementById('add-ordre-du-jour').addEventListener('click', function() {
    const table = document.getElementById('ordre-du-jour-table').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();
    newRow.innerHTML = `
      <td><input type="text" class="form-control" name="point[]" placeholder="Entrez un point à l'ordre du jour" required></td>
      <td class="action-buttons">
        <button type="button" class="btn btn-reorder btn-sm move-up" title="Monter ce point" disabled><i class="fas fa-arrow-up"></i></button>
        <button type="button" class="btn btn-reorder btn-sm move-down" title="Descendre ce point"><i class="fas fa-arrow-down"></i></button>
        <button type="button" class="btn btn-danger btn-sm remove-row" title="Supprimer ce point"><i class="fas fa-trash"></i></button>
      </td>`;
    attachAllEventListeners();
    updateReorderButtons('ordre-du-jour-table');
    updateJsonData();
  });

  document.getElementById('add-participant').addEventListener('click', function() {
    const table = document.getElementById('participants-table').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();
    newRow.innerHTML = `
      <td><input type="text" class="form-control" name="nom[]" placeholder="Nom du participant" required></td>
      <td><input type="text" class="form-control" name="role[]" placeholder="Rôle du participant" required></td>
      <td><button type="button" class="btn btn-danger btn-sm remove-row" title="Supprimer ce participant"><i class="fas fa-trash"></i></button></td>`;
    attachAllEventListeners();
    updateJsonData();
  });

  document.getElementById('add-teneur').addEventListener('click', function() {
    const table = document.getElementById('teneur-de-la-reunion-table').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();
    newRow.innerHTML = `
      <td><input type="text" class="form-control" name="point_ordre_du_jour[]" placeholder="Point de l'ordre du jour" required></td>
      <td><textarea class="form-control" name="discussion[]" placeholder="Discussion sur ce point"></textarea></td>
      <td class="action-buttons">
        <button type="button" class="btn btn-reorder btn-sm move-up" title="Monter ce point"><i class="fas fa-arrow-up"></i></button>
        <button type="button" class="btn btn-reorder btn-sm move-down" title="Descendre ce point"><i class="fas fa-arrow-down"></i></button>
        <button type="button" class="btn btn-danger btn-sm remove-row" title="Supprimer ce point"><i class="fas fa-trash"></i></button>
      </td>`;
    attachAllEventListeners();
    updateReorderButtons('teneur-de-la-reunion-table');
    updateJsonData();
  });

  document.getElementById('add-recap').addEventListener('click', function() {
    const table = document.getElementById('recapitulatif-table').getElementsByTagName('tbody')[0];
    const newRow = table.insertRow();
    newRow.innerHTML = `
      <td><input type="text" class="form-control" name="tache[]" placeholder="Tâche à accomplir" required></td>
      <td><input type="text" class="form-control" name="responsable[]" placeholder="Responsable de la tâche" required></td>
      <td><input type="date" class="form-control" name="echeance[]" required></td>
      <td><button type="button" class="btn btn-danger btn-sm remove-row" title="Supprimer cette tâche"><i class="fas fa-trash"></i></button></td>`;
    attachAllEventListeners();
    updateJsonData();
  });

  // Collecte des données du formulaire et mise à jour du champ caché
  function updateJsonData() {
    const formData = {
      objet: document.querySelector('[name="objet"]').value,
      date: document.querySelector('[name="date"]').value,
      lieu: document.querySelector('[name="lieu"]').value,
      ordre_du_jour: Array.from(document.querySelectorAll('[name="point[]"]')).map(el => el.value),
      participants: Array.from(document.querySelectorAll('[name="nom[]"]')).map((el, i) => ({
        nom: el.value,
        role: document.querySelectorAll('[name="role[]"]')[i]?.value || ""
      })),
      teneur_de_la_reunion: Array.from(document.querySelectorAll('[name="point_ordre_du_jour[]"]')).map((el, i) => ({
        point_ordre_du_jour: el.value,
        discussion: document.querySelectorAll('[name="discussion[]"]')[i]?.value || ""
      })),
      recapitulatif_qui_fait_quoi: Array.from(document.querySelectorAll('[name="tache[]"]')).map((el, i) => ({
        tache: el.value,
        responsable: document.querySelectorAll('[name="responsable[]"]')[i]?.value || "",
        echeance: document.querySelectorAll('[name="echeance[]"]')[i]?.value || ""
      }))
    };
    const hidden = document.getElementById('json-data-input');
    if (hidden) hidden.value = JSON.stringify({ reunion: formData });
  }

  document.getElementById('meetingForm').addEventListener('change', updateJsonData);

  // Init
  attachAllEventListeners();
  updateReorderButtons('ordre-du-jour-table');
  updateReorderButtons('teneur-de-la-reunion-table');
  updateJsonData(); // Mise à jour initiale
});
</script>
{% endblock %}
